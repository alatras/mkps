def _ACCOUNT_NAME = env.ACCOUNT_NAME == "eos" || env.ACCOUNT_NAME == "test" ? "eos" : params.account_name
def _ENV_NAME = env.JOB_NAME.contains('dev') ? "dev" : env.JOB_NAME.contains('qa') ? "qa" : env.JOB_NAME.contains('uat') ? "uat" : env.ENV_NAME
def _BRANCH = _ENV_NAME == "dev" ? "main" : _ENV_NAME == "qa" ||  _ENV_NAME == "uat" ? "qa" : ""

pipeline {
    agent any

    options {
        buildDiscarder(logRotator(
                artifactDaysToKeepStr: '',
                artifactNumToKeepStr: '5',
                daysToKeepStr: '60',
                numToKeepStr: '20')
        )
        disableConcurrentBuilds()
        disableResume()
        timeout(time: 1, unit: 'HOURS')
        ansiColor('xterm')
    }

    parameters {
        string(name: "account_name", defaultValue: "${env.ACCOUNT_NAME}", description: "Account name to use for deployment")
        string(name: "environment", defaultValue: "${_ENV_NAME}", description: "Environment name to use for deployment")
        string(name: "aws_region", defaultValue: "${env.REGION}", description: 'AWS Region to use for deployment')
        string(name: "branch", defaultValue: "${_BRANCH}", description: 'Add branch name or tag')
    }

    stages {
        stage('Create variables') {
            steps {
                script {
                    if (env.JOB_NAME.contains('nft')) {
                        _SERVICE = "nft"
                    }    
                    else if (env.JOB_NAME.contains('user')) {
                        _SERVICE = "user"
                    }    
                    else if (env.JOB_NAME.contains('avn')) {
                        _SERVICE = "avn"
                    }    
                    else if (env.JOB_NAME.contains('payment')) {
                        _SERVICE = "payment"
                    }    
                    else if (env.JOB_NAME.contains('minting')) {
                        _SERVICE = "minting"
                    }    
                    else if (env.JOB_NAME.contains('asset')) {
                        _SERVICE = "asset"
                    }    


                    account_id = sh (script: "aws sts get-caller-identity --query 'Account' --output text", returnStdout: true).trim()
                    account_id_base = "696165561482"
                    aws_region_base = "us-east-2"
                    
                    tenant_secret_id = "arn:aws:secretsmanager:${params.aws_region}:$account_id:secret:/${params.environment}/service/tenant"
                    package_name = sh (script: "aws secretsmanager get-secret-value --region ${params.aws_region} --secret-id $tenant_secret_id | jq -r .SecretString | jq -r .package", returnStdout: true).trim()                    

                    namespace = "app-${params.environment}"
                    helm_chart = "values-${params.account_name}-${params.environment}-${_SERVICE}-service.yaml"
                    tag = "v$BUILD_NUMBER"
                    latest = "latest"

                    if ("${params.account_name}" == "test") {
                        tag = "v${params.environment}-$BUILD_NUMBER"
                        latest = "${params.environment}-latest"                        
                    } 
                    if ("${params.account_name}" == "demo") {
                        namespace = "app-pentest-${_SERVICE}-service.yaml"
                    }
                }
            }
        }

        stage('Build') {
            steps {
                sh "aws ecr get-login-password --region ${params.aws_region} | docker login --username AWS --password-stdin ${account_id}.dkr.ecr.${params.aws_region}.amazonaws.com"
                sh "aws ecr get-login-password --region ${aws_region_base} | docker login --username AWS --password-stdin ${account_id_base}.dkr.ecr.${aws_region_base}.amazonaws.com"

                sh "docker build -t ${account_id}.dkr.ecr.${params.aws_region}.amazonaws.com/${_SERVICE}-service:${tag}  --build-arg PACKAGE=${package_name} --build-arg ENVIRONMENT=${params.environment} ."
            }
        }

        stage('Publish') {
            steps {
                sh "docker push ${account_id}.dkr.ecr.${params.aws_region}.amazonaws.com/${_SERVICE}-service:${tag}"
            }
        }

        stage('Clean') {
            steps {
                sh "docker image rm ${account_id}.dkr.ecr.${params.aws_region}.amazonaws.com/${_SERVICE}-service:${tag}"
            }
        }

        stage('Deploy') {
            steps {
                dir('chart/services') {
                    sh "helm upgrade --install --set image.tag=${tag} ${_SERVICE} -f ${helm_chart} . -n ${namespace}"
                }
            }
        }
    }
}
